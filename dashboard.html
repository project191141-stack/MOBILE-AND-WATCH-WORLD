<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Data View</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 1100px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { text-align: center; text-transform: uppercase; margin-bottom: 30px; letter-spacing: 1px; }
        
        /* Navigation */
        .nav-bar { display: flex; justify-content: space-between; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-nav { padding: 10px 20px; background: #000; color: white; text-decoration: none; font-weight: bold; border: none; cursor: pointer; border-radius: 4px; font-size: 0.9rem;}
        .btn-logout { background: #d32f2f; }
        .btn-nav:hover { opacity: 0.8; }

        /* Search Section */
        .search-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .search-inner { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; color: #555; }
        input, select { padding: 10px; border: 1px solid #ddd; width: 130px; border-radius: 4px; font-size: 14px; }
        
        /* Visibility Buttons */
        .visibility-controls { display: flex; gap: 10px; margin-left: auto; }
        .btn-show { background: #2e7d32; color: white; }
        .btn-hide { background: #555; color: white; }

        /* Stats Cards */
        .dashboard-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; border-radius: 8px; background: #fff; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid #000; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 1rem; color: #666; }
        .stat-card span { font-size: 1.5rem; font-weight: bold; }
        
        /* Tables */
        .data-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .table-wrapper { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 200px;}
        h3.table-title { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #000; color: #fff; padding: 12px; text-align: left; font-size: 0.9rem; }
        td { border-bottom: 1px solid #eee; padding: 10px; font-size: 0.9rem; }
        tr:hover { background-color: #f5f5f5; }
        
        .action-btn { background: #fff; border: 1px solid #ccc; cursor: pointer; color: red; padding: 5px 10px; border-radius: 4px; }
        .action-btn:hover { background: #fee; border-color: red; }
        
        /* Privacy Overlay */
        .blur-text { filter: blur(5px); user-select: none; }
        #hidden-msg { text-align: center; color: #888; margin-top: 50px; font-style: italic; display: none; }

        @media (max-width: 768px) { .data-section, .dashboard-stats { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="add-entry.html" class="btn-nav"> + ADD NEW ENTRY</a>
        <button onclick="logout()" class="btn-nav btn-logout">LOGOUT</button>
    </div>

    <h1>Data Dashboard</h1>

    <div class="search-container">
        <div class="search-inner">
            <div class="input-group">
                <label>Date</label>
                <select id="searchDay" onchange="renderAll()"><option value="">Day</option></select>
            </div>
            <div class="input-group">
                <label>Month</label>
                <select id="searchMonth" onchange="renderAll()">
                    <option value="">Month</option>
                    <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
                    <option value="04">Apr</option><option value="05">May</option><option value="06">Jun</option>
                    <option value="07">Jul</option><option value="08">Aug</option><option value="09">Sep</option>
                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                </select>
            </div>
            <div class="input-group">
                <label>Year</label>
                <input type="number" id="searchYear" placeholder="Year" onkeyup="renderAll()">
            </div>
            
            <div class="visibility-controls">
                <button class="btn-nav btn-show" onclick="forceShowAll()">SHOW ALL</button>
                <button class="btn-nav btn-hide" onclick="hideAll()">HIDE DATA</button>
            </div>
        </div>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card" style="border-top-color: green;">
            <h3>Total Sales</h3>
            <span id="dashSales" style="color:green;">---</span>
        </div>
        <div class="stat-card" style="border-top-color: red;">
            <h3>Total Expenses</h3>
            <span id="dashExp" style="color:red;">---</span>
        </div>
        <div class="stat-card" style="border-top-color: blue;">
            <h3>Net Profit</h3>
            <span id="dashProfit">---</span>
        </div>
    </div>

    <div class="data-section">
        <div class="table-wrapper">
            <h3 class="table-title">Sales History</h3>
            <table id="salesTable">
                <thead><tr><th>Date</th><th>Item</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="salesList"></tbody>
            </table>
            <div id="salesMsg" class="empty-msg">Select a date to view data...</div>
        </div>
        <div class="table-wrapper">
            <h3 class="table-title">Expense History</h3>
            <table id="expTable">
                <thead><tr><th>Date</th><th>Reason</th><th>Cost</th><th>Action</th></tr></thead>
                <tbody id="expList"></tbody>
            </table>
            <div id="expMsg" class="empty-msg">Select a date to view data...</div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA__gk4XftwQZ_UlqI6WwrO0Quxre_2nuY",
      authDomain: "mobile-and-watch-world.firebaseapp.com",
      databaseURL: "https://mobile-and-watch-world-default-rtdb.firebaseio.com",
      projectId: "mobile-and-watch-world",
      storageBucket: "mobile-and-watch-world.firebasestorage.app",
      messagingSenderId: "621266068216",
      appId: "1:621266068216:web:8f4fc8bfd5c12c0b18110d",
      measurementId: "G-7ZLPQTBY6C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let inventory = [];
    let showOverride = false; // Flag to check if user clicked "Show All"

    // Auth Check
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "login.html";
        else loadData();
    });

    window.logout = () => signOut(auth).then(() => window.location.href = "login.html");

    // Load Data
    function loadData() {
        const dataRef = ref(db, 'transactions');
        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            inventory = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    inventory.push({ id: key, ...data[key] });
                });
            }
            renderAll(); 
        });
    }

    // Populate Day Dropdown
    const select = document.getElementById('searchDay');
    for(let i=1; i<=31; i++) {
        let val = i < 10 ? '0'+i : i;
        select.innerHTML += `<option value="${val}">${i}</option>`;
    }

    window.deleteItem = (id) => {
        if(confirm("Delete this item permanently?")) {
            remove(ref(db, 'transactions/' + id));
        }
    };

    // --- VISIBILITY CONTROLS ---
    window.forceShowAll = () => {
        showOverride = true;
        // Reset filters visually so users know they are seeing everything
        document.getElementById('searchDay').value = "";
        document.getElementById('searchMonth').value = "";
        document.getElementById('searchYear').value = "";
        renderAll();
    };

    window.hideAll = () => {
        showOverride = false;
        // Reset filters
        document.getElementById('searchDay').value = "";
        document.getElementById('searchMonth').value = "";
        document.getElementById('searchYear').value = "";
        renderAll();
    }

    // --- RENDER LOGIC ---
    window.renderAll = () => {
        const sDay = document.getElementById('searchDay').value;
        const sMonth = document.getElementById('searchMonth').value;
        const sYear = document.getElementById('searchYear').value;
        
        // PRIVACY CHECK:
        // If no filters are selected AND "Show All" hasn't been clicked, HIDE everything.
        if (!sDay && !sMonth && !sYear && !showOverride) {
            document.getElementById('salesList').innerHTML = "";
            document.getElementById('expList').innerHTML = "";
            document.getElementById('dashSales').innerText = "---";
            document.getElementById('dashExp').innerText = "---";
            document.getElementById('dashProfit').innerText = "---";
            document.getElementById('salesMsg').style.display = "block";
            document.getElementById('expMsg').style.display = "block";
            return; 
        }

        // If we proceed, hide the "Select a date" messages
        document.getElementById('salesMsg').style.display = "none";
        document.getElementById('expMsg').style.display = "none";

        let salesTotal = 0, expTotal = 0;
        const salesBody = document.getElementById('salesList');
        const expBody = document.getElementById('expList');
        salesBody.innerHTML = ''; expBody.innerHTML = '';

        const sortedInv = [...inventory].sort((a,b) => new Date(b.date) - new Date(a.date));

        sortedInv.forEach(item => {
            const [y, m, d] = item.date.split('-');
            if(sDay && sDay !== d) return;
            if(sMonth && sMonth !== m) return;
            if(sYear && sYear !== y) return;

            const row = `<tr>
                <td>${item.date}</td>
                <td>${item.name}</td>
                <td>₹${item.price.toFixed(2)}</td>
                <td><button class="action-btn" onclick="deleteItem('${item.id}')">✖</button></td>
            </tr>`;

            if(item.type === 'sale') { salesTotal += item.price; salesBody.innerHTML += row; } 
            else { expTotal += item.price; expBody.innerHTML += row; }
        });

        document.getElementById('dashSales').innerText = `₹${salesTotal.toFixed(2)}`;
        document.getElementById('dashExp').innerText = `₹${expTotal.toFixed(2)}`;
        const profit = salesTotal - expTotal;
        const profitEl = document.getElementById('dashProfit');
        profitEl.innerText = `₹${profit.toFixed(2)}`;
        profitEl.style.color = profit >= 0 ? 'green' : 'red';
    };
</script>
</body>
</html>